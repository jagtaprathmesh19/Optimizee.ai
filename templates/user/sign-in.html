{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="{% static 'assets/img/apple-icon.png' %}"
    />
    <link
      rel="icon"
      type="image/png"
      href="{% static 'assets/img/favicon.png' %}"
    />
    <title>Optimizee.ai - Sign In</title>

    <!-- Security headers -->
    {% comment %}
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' https://kit.fontawesome.com https://buttons.github.io; style-src 'self' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https://raw.githubusercontent.com data:;"
    />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    {% endcomment %}

    <!--     Fonts and icons     -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <!-- Nucleo Icons -->
    <link
      href="https://demos.creative-tim.com/argon-dashboard-pro/assets/css/nucleo-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://demos.creative-tim.com/argon-dashboard-pro/assets/css/nucleo-svg.css"
      rel="stylesheet"
    />
    <!-- Font Awesome Icons -->
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>
    <!-- CSS Files -->
    <link id="pagestyle" href="{% static "assets/css/argon-dashboard.css" %}"
    rel="stylesheet" />
  </head>

  <body class="">
    <main class="main-content mt-0">
      <section>
        <div class="page-header min-vh-100">
          <div class="container">
            <div class="row">
              <div
                class="col-xl-4 col-lg-5 col-md-7 d-flex flex-column mx-lg-0 mx-auto"
              >
                <div class="card card-plain">
                  <div class="card-header pb-0 text-start">
                    <h4 class="font-weight-bolder">Sign In</h4>
                    <p class="mb-0">Enter your email and password to sign in</p>
                  </div>
                  <div class="card-body">
                    <form role="form" id="loginForm">
                      <div class="mb-3">
                        <input
                          type="text"
                          id="username"
                          class="form-control form-control-lg"
                          placeholder="Username or Email"
                          aria-label="Username"
                          autocomplete="username"
                          autofocus
                          required
                        />
                      </div>
                      <div class="mb-3 position-relative">
                        <input
                          type="password"
                          id="password"
                          class="form-control form-control-lg"
                          placeholder="Password"
                          name="password"
                          autocomplete="current-password"
                          aria-label="Password"
                          required
                        />
                        <span
                          class="position-absolute end-0 top-0 mt-3 me-3 password-toggle"
                          style="cursor: pointer; z-index: 2"
                        >
                          <i class="fas fa-eye"></i>
                        </span>
                      </div>
                      <div class="form-check form-switch mb-3">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="rememberMe"
                          name="remember_me"
                        />
                        <label class="form-check-label" for="rememberMe"
                          >Remember me</label
                        >
                      </div>
                      <p id="loginMessage" class="text-center"></p>
                      <div class="text-center">
                        <button
                          type="submit"
                          class="btn btn-lg btn-primary btn-lg w-100 mt-4 mb-0"
                          id="submitBtn"
                        >
                          Sign in
                          <span
                            class="spinner-border spinner-border-sm d-none"
                            id="spinner"
                          ></span>
                        </button>
                      </div>
                    </form>
                  </div>
                  <div class="card-footer text-center pt-0 px-lg-2 px-1">
                    <p class="mb-4 text-sm mx-auto">
                      Don't have an account?
                      <a
                        href="{% url 'authapp:register' %}"
                        class="text-primary text-gradient font-weight-bold"
                        >Sign up</a
                      >
                    </p>
                    <p class="mb-0 text-sm">
                      <a
                        href="/auth/password-reset/"
                        class="text-primary text-gradient font-weight-bold"
                        >Forgot password?</a
                      >
                    </p>
                  </div>
                </div>
              </div>
              <div
                class="col-6 d-lg-flex d-none h-100 my-auto pe-0 position-absolute top-0 end-0 text-center justify-content-center flex-column"
              >
                <div
                  class="position-relative bg-gradient-primary h-100 m-3 px-7 border-radius-lg d-flex flex-column justify-content-center overflow-hidden"
                  style="
                    background-image: url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/signin-ill.jpg');
                    background-size: cover;
                  "
                >
                  <span class="mask bg-gradient-primary opacity-6"></span>
                  <h4
                    class="mt-5 text-white font-weight-bolder position-relative"
                  >
                    "Food Is Life"
                  </h4>
                  <p class="text-white position-relative">
                    The more effortless your donation, the more effort we put
                    into making it count.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!--   Core JS Files   -->
    <script src="{% static 'assets/js/core/popper.min.js' %}"></script>
    <script src="{% static 'assets/js/core/bootstrap.min.js' %}"></script>
    <script src="{% static 'assets/js/plugins/perfect-scrollbar.min.js' %}"></script>
    <script src="{% static 'assets/js/plugins/smooth-scrollbar.min.js' %}"></script>
    <script src="{% static 'assets/js/auth.js' %}"></script>

    <script>
      var win = navigator.platform.indexOf("Win") > -1;
      if (win && document.querySelector("#sidenav-scrollbar")) {
        var options = {
          damping: "0.5",
        };
        Scrollbar.init(document.querySelector("#sidenav-scrollbar"), options);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        const passwordToggle = document.querySelector(".password-toggle");
        const submitBtn = document.getElementById("submitBtn");
        const spinner = document.getElementById("spinner");
        const loginMessage = document.getElementById("loginMessage");

        // Redirect already authenticated users
        if (Auth.isAuthenticated()) {
          window.location.href = "{% url 'authapp:profile' %}";
          return;
        }

        // Password visibility toggle
        passwordToggle.addEventListener("click", function () {
          const icon = this.querySelector("i");
          const passwordField = document.getElementById("password");

          if (passwordField.type === "password") {
            passwordField.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
          } else {
            passwordField.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
          }
        });

        // Form submission
        loginForm.addEventListener("submit", async function (event) {
          event.preventDefault();
          loginForm.classList.add("was-validated");

          if (!loginForm.checkValidity()) return;

          loginMessage.textContent = "";

          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();
          const rememberMe = document.getElementById("rememberMe").checked;

          if (!username || !password) {
            showMessage("Please enter both username and password", "danger");
            return;
          }
          // Disable button and show spinner
          submitBtn.disabled = true;
          spinner.classList.remove("d-none");

          try {
            // Use Auth service from auth.js
            const result = await Auth.login(username, password, rememberMe);

            if (result.success) {
              // Success: redirect to profile page
              showMessage("Login successful, redirecting...", "success");
              setTimeout(() => {
                window.location.href = "{% url 'authapp:profile' %}";
              }, 500);
            } else {
              // Handle error response
              submitBtn.disabled = false;
              spinner.classList.add("d-none");
              showMessage(result.error || "Login failed", "danger");
            }
          } catch (error) {
            // Handle unexpected errors
            console.error("Login error:", error);
            submitBtn.disabled = false;
            spinner.classList.add("d-none");
            showMessage(
              "An error occurred during login. Please try again.",
              "danger"
            );
          }
        });

        // Show status message
        function showMessage(message, type) {
          loginMessage.textContent = message;
          loginMessage.className = `text-center mb-2 small text-${type}`;
        }
        // Clear message when input changes
        const inputs = loginForm.querySelectorAll("input");
        inputs.forEach((input) => {
          input.addEventListener("input", () => {
            loginMessage.textContent = "";
          });
        });
      });
    </script>

    <script src="{% static 'assets/js/plugins/chartjs.min.js' %}"></script>
    <!-- Github buttons -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="{% static 'assets/js/argon-dashboard.min.js' %}"></script>
  </body>
</html>
