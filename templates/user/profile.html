{% extends "base.html" %} {% load static %} 
{% block title %} Profile {% endblock title %} {% block content %}

  <div
    class="position-absolute w-100 min-height-300 top-0"
    style="
      background-image: url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/profile-layout-header.jpg');
      background-position-y: 50%;
    ">
    <span class="mask bg-primary opacity-6"></span>
  </div>

  <div class="main-content position-relative max-height-vh-100 h-100">
    <div class="card shadow-lg mx-4 card-profile-bottom">
      <div class="card-body p-3">
        <div class="row gx-4">
          <div class="col-auto">
            <div class="avatar avatar-xl position-relative">
              <img
                src="{% static 'assets/img/default-avatar.png' %}"
                alt="profile_image"
                class="w-100 border-radius-lg shadow-sm"
              />
            </div>
          </div>
          <div class="col-auto my-auto">
            <div class="h-100">
              <h5 class="mb-1" id="profile-username">
                {{ request.user.username }}
              </h5>
              <p class="mb-0 font-weight-bold text-sm">User Profile</p>
            </div>
          </div>
          <div
            class="col-lg-4 col-md-6 my-sm-auto ms-sm-auto me-sm-0 mx-auto mt-3"
          >
            <div class="nav-wrapper position-relative end-0">
              <ul class="nav nav-pills nav-fill p-1" role="tablist">
                <li class="nav-item">
                  <a
                    class="nav-link mb-0 px-0 py-1 active d-flex align-items-center justify-content-center"
                    data-bs-toggle="tab"
                    href="javascript:;"
                    role="tab"
                    aria-selected="true"
                  >
                    <i class="ni ni-badge"></i>
                    <span class="ms-2">Profile</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link mb-0 px-0 py-1 d-flex align-items-center justify-content-center"
                    data-bs-toggle="tab"
                    href="javascript:;"
                    role="tab"
                    aria-selected="false"
                  >
                    <i class="ni ni-settings-gear-65"></i>
                    <span class="ms-2">Settings</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Profile Update Form -->
     <div id="profile-content" style="display: none;"></div>
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header pb-0">
              <div class="d-flex align-items-center">
                <p class="mb-0">Edit Profile</p>
                <button
                  class="btn btn-primary btn-sm ms-auto"
                  id="saveProfileBtn"
                >
                  Save Changes
                  <span
                    class="spinner-border spinner-border-sm d-none"
                    id="saveSpinner"
                  ></span>
                </button>
              </div>
            </div>
            <div class="card-body">
              <form id="profileForm">
                <!-- User Information -->
                <p class="text-uppercase text-sm">User Information</p>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="example-text-input" class="form-control-label"
                        >Username</label>
                      <input
                        class="form-control"
                        type="text"
                        id="username"
                        readonly
                      />
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="example-text-input" class="form-control-label"
                        >Email address</label
                      >
                      <input
                        class="form-control"
                        type="email"
                        id="email"
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="example-text-input" class="form-control-label"
                        >First name</label
                      >
                      <input
                        class="form-control"
                        type="text"
                        id="first_name"
                      />
                      <div class="invalid-feedback" id="first_nameError"></div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="example-text-input" class="form-control-label"
                        >Last name</label
                      >
                      <input
                        class="form-control"
                        type="text"
                        id="last_name"
                      />
                      <div class="invalid-feedback" id="last_nameError"></div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-control-label">Phone Number</label>
                      <input
                        class="form-control"
                        type="tel"
                        id="phone_number"
                      />
                      <div
                        class="invalid-feedback"
                        id="phone_numberError"
                      ></div>
                    </div>
                  </div>
                </div>

                <hr class="horizontal dark" />
                <!-- Contact Information -->
                <p class="text-uppercase text-sm">Contact Information</p>
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="example-text-input" class="form-control-label"
                        >Address</label
                      >
                      <textarea class="form-control" id="address"></textarea>
                      <div class="invalid-feedback" id="addressError"></div>
                    </div>
                  </div>
                </div>

                <hr class="horizontal dark" />
                <!-- Allergies -->
                <p class="text-uppercase text-sm">Health Preferences</p>
                <div class="row">
                  <div class="col-md-12">
                    <div class="form-group">
                      <label for="example-text-input" class="form-control-label"
                        >Allergies / Dietary Restrictions</label
                      >
                      <textarea
                        class="form-control"
                        placeholder="flowers, kiwi, dairy foods etc."
                        id="allergies"></textarea>
                      <div class="invalid-feedback" id="allergiesError"></div>
                    </div>
                  </div>
                </div>
              </form>
              <p id="profileMessage" class="alert d-none mt-3"></p>
            </div>
          </div>
        </div>

        <!-- Profile Image -->
        <div class="col-md-4">
          <div class="card card-profile">
            <!-- Profile Cover Image -->
            <img
              src="{% static 'assets/img/bg-profile.jpg' %}"
              alt="Profile Cover"
              class="card-img-top"
            />
            <!-- Profile Picture -->
            <div class="row justify-content-center">
              <div class="col-4 col-lg-4 order-lg-2">
                <div class="mt-n4 mt-lg-n6 mb-4 mb-lg-0">
                  <a href="javascript:;">
                    <img
                      src="{% static 'assets/img/default-avatar.png' %}"
                      class="rounded-circle img-fluid border border-2 border-white"
                      id="profile-image"
                    />
                  </a>
                </div>
              </div>
            </div>

            <!-- User Information -->
            <!-- <div class="card-header text-center border-0 pt-0 pt-lg-2 pb-4 pb-lg-3">
              <div class="d-flex justify-content-between">
                <a href="javascript:;" class="btn btn-sm btn-info mb-0 d-none d-lg-block">Connect</a>
                <a href="javascript:;" class="btn btn-sm btn-info mb-0 d-block d-lg-none"><i
                    class="ni ni-collection"></i></a>
                <a href="javascript:;" class="btn btn-sm btn-dark float-right mb-0 d-none d-lg-block">Message</a>
                <a href="javascript:;" class="btn btn-sm btn-dark float-right mb-0 d-block d-lg-none"><i
                    class="ni ni-email-83"></i></a>
              </div>
            </div> -->
            <div class="card-body pt-0">
              <!-- <div class="row">
                <div class="col">
                  <div class="d-flex justify-content-center">
                    <div class="d-grid text-center">
                      <span class="text-lg font-weight-bolder">22</span>
                      <span class="text-sm opacity-8">Friends</span>
                    </div>
                    <div class="d-grid text-center mx-4">
                      <span class="text-lg font-weight-bolder">10</span>
                      <span class="text-sm opacity-8">Photos</span>
                    </div>
                    <div class="d-grid text-center">
                      <span class="text-lg font-weight-bolder">89</span>
                      <span class="text-sm opacity-8">Comments</span>
                    </div>
                  </div>
                </div>
              </div> -->
              <div class="text-center mt-4">
                <h5 id="profile-username">{{ request.user.username }}</h5>
                <h6 class="text-muted">
                  {{ request.user.first_name }} {{ request.user.last_name }}
                </h6>
                <span class="text-sm text-primary"
                  >Joined on: {{ request.user.date_joined|date:"F d, Y" }}</span
                >
                <div class="text-center mt-3">
                  <p>
                    <i class="ni ni-pin-3 mr-2"></i>
                    <span id="profile-address">
                      {% if request.user.profile.address %} {{
                      request.user.profile.address }} {% else %} Address not set
                      {% endif %}
                    </span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer pt-3">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-6 mb-lg-0 mb-4">
              <div
                class="copyright text-center text-sm text-muted text-lg-start"
              >
                ©
                <script>
                  document.write(new Date().getFullYear());
                </script>
                , made with <i class="fa fa-heart"></i> by
                <a
                  href="https://www.creative-tim.com"
                  class="font-weight-bold"
                  target="_blank"
                  >QSpiders</a
                >
                for a better world.
              </div>
            </div>
            <div class="col-lg-6">
              <ul
                class="nav nav-footer justify-content-center justify-content-lg-end"
              >
                <li class="nav-item">
                  <a
                    href="https://www.linkedin.com/in/jagtaprathmesh19/"
                    class="nav-link text-muted"
                    target="_blank"
                    >Creators</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    href="https://github.com/jagtaprathmesh19/"
                    class="nav-link text-muted"
                    target="_blank"
                    >About Us</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    href="https://medium.com/@jagtaprathmesh19"
                    class="nav-link text-muted"
                    target="_blank"
                    >Blog</a
                  >
                </li>
                <li class="nav-item">
                  <a
                    href="/user/dashboard/"
                    class="nav-link pe-0 text-muted"
                    target="_blank"
                    >License</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>
    <div id="profile-loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p>Loading profile...</p>
    </div>
  </div>

  {% endblock content %}
  <script src="{% static 'assets/js/auth.js' %}"></script>
  {% block script %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!Auth.isAuthenticated()) {
        console.error("No authentication token found");
        Auth.redirectToLogin();
        return;
      }

      const elements = {
        form: document.getElementById("profileForm"),
        saveBtn: document.getElementById("saveProfileBtn"),
        spinner: document.getElementById("saveSpinner"),
        message: document.getElementById("profileMessage"),
        fields: {
          username: document.getElementById("username"),
          email: document.getElementById("email"),
          first_name: document.getElementById("first_name"),
          last_name: document.getElementById("last_name"),
          phone_number: document.getElementById("phone_number"),
          address: document.getElementById("address"),
          allergies: document.getElementById("allergies"),
        },
      };

      document.addEventListener("DOMContentLoaded", function () {
        Auth.updateAuthUI();

      // Use event delegation for logout links
      document.body.addEventListener("click", function (e) {
        if (e.target.closest(".logout-link")) {
          e.preventDefault();
          Auth.logout();
        }
      });
    });

    document.getElementById("profile-content").style.display = "none";
    document.getElementById("profile-loading").style.display = "block";

      // Fetch and populate profile data
      async function loadProfile() {
        try {
          const data = await Auth.fetchWithAuth(
            "/auth/api/profile/"
          );
          console.log("Fetching profile data...", data);
          document.getElementById("profile-content").style.display = "block";
          document.getElementById("profile-loading").style.display = "none";

          // Update form fields
          if (data.user) {
            elements.fields.username.value = data.user.username || "";
            elements.fields.email.value = data.user.email || "";
            elements.fields.first_name.value = data.user.first_name || "";
            elements.fields.last_name.value = data.user.last_name || "";
          }
          elements.fields.phone_number.value = data.phone_number || data.profile?.phone_number || "";
          elements.fields.address.value = data.address || data.profile?.address || "";
          elements.fields.allergies.value = data.allergies || data.profile?.allergies || "";

          // Update profile card
          document.querySelectorAll("#profile-username").forEach((el) => {
            el.textContent = data.user?.username || "N/A";
          });

          document.getElementById("profile-address").textContent =
            data.profile?.address || "Address not set";

          const nameLine = document.querySelector(".card-body .text-muted");
          if (nameLine) {
            const fullName = [data.user?.first_name, data.user?.last_name]
              .filter(Boolean)
              .join(" ");
            nameLine.textContent = fullName || "No name set";
          }
        } catch (error) {
          if (error.status === 401) {
            // Handle unauthorized specifically
            showMessage("Session expired. Please log in again.", "warning");
            setTimeout(() => Auth.redirectToLogin(), 2000);
          } else {
            showMessage("Failed to load profile data", "danger");
            console.error("Profile load error:", error);
          }
        }
      }

      // Handle form submission
      async function updateProfile(e) {
        e.preventDefault();
        elements.saveBtn.disabled = true;
        elements.spinner.classList.remove("d-none");
        clearErrors();

        const payload = {
          first_name: elements.fields.first_name.value.trim(),
          last_name: elements.fields.last_name.value.trim(),

          phone_number: elements.fields.phone_number.value.trim(),
          address: elements.fields.address.value.trim(),
          allergies: elements.fields.allergies.value.trim(),
        };

        try {
          await Auth.fetchWithAuth("/auth/api/profile/", {
            method: "PUT",
            body: payload,
          });

          showMessage("Profile updated successfully!", "success");
          await loadProfile(); // Refresh data
        } catch (error) {
          if (error.status === 400) {
            handleValidationErrors(error.data);
          } else {
            showMessage("Failed to update profile", "danger");
          }
          console.error("Update error:", error);
        } finally {
          elements.saveBtn.disabled = false;
          elements.spinner.classList.add("d-none");
        }
      }

      // Helper functions
      function clearErrors() {
        elements.message.classList.add("d-none");
        document.querySelectorAll(".is-invalid").forEach((el) => {
          el.classList.remove("is-invalid");
        });
      }
      function handleValidationErrors(errors) {
        for (const [field, messages] of Object.entries(errors)) {
          const key = field.includes(".") ? field.split(".")[1] : field;
          const errorElement = document.getElementById(`${key}Error`);
          const inputElement = elements.fields[key];

          if (inputElement && errorElement) {
            inputElement.classList.add("is-invalid");
            errorElement.textContent = Array.isArray(messages)
              ? messages[0]
              : messages;
          } else {
            // Show general error message if field not found
            showMessage(
              `Validation error: ${JSON.stringify(messages)}`,
              "danger"
            );
          }
        }
      }

      function showMessage(text, type) {
        elements.message.textContent = text;
        elements.message.className = `alert alert-${type} d-block`;
        setTimeout(() => elements.message.classList.add("d-none"), 5000);
      }

      // Event listeners
      elements.saveBtn.addEventListener("click", updateProfile);
      loadProfile();
    });
  </script>
  {% endblock script %}
</body>
